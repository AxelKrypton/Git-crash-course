\documentclass[usenames,svgnames,14pt]{beamer}
\usepackage[english]{babel}
\usepackage{
  fontspec,
  fontawesome,
  xcolor,
  mathabx,
  listings,
  lstautogobble,
  listofitems,
  TeXnicalities,
  animate,comment
}

\setsansfont{Yanone Kaffeesatz}[
    UprightFont     = *-Regular ,
    BoldFont        = *-Bold ,
    BoldItalicFont  = *-Bold ,
    BoldSlantedFont = *-Bold ,
    ItalicFont      = *-Light ,
    SlantedFont     = *-Light ,
    SmallCapsFont   = *-Thin
]
\graphicspath{{../Figures/}}
\usetheme[style=green]{Z02}

\usetikzlibrary{
    positioning,
    shapes,
    bbox
}
\input{../Tex_tools/ListingsBash}

%===============================================================%
\title{Let's Git together}
\date{XX August 2022}
\author{Alessandro Sciarra}
\institute{Z02~--~Software Development Center}
\titlegraphic{\includegraphics[width=20mm]{LogoCRC}}
\titlepagelogo{\includegraphics[width=20mm]{LogoGoethe}}
%===============================================================%

\AtBeginSection[] % <- Empty optional argument, do nothing for \section*
{
    \begin{frame}[plain, noframenumbering]{}
         \sectionpage
    \end{frame}
}

\tikzset{
    space/.style={%
        thick, draw=#1, fill=#1!10, text=#1, rounded corners=1mm, font=\small, text width=14mm, align=center, minimum height=12mm
    }
}
\PrepareURLsymbol[PB]
\newcommand{\ttc}[2]{\texttt{\textcolor{#1}{#2}}}%
\setlength{\leftmarginii}{0.5cm}
\newcommand{\then}{\raisebox{2pt}{$\;\drsh\;$}}

% Taken from https://tex.stackexchange.com/a/51458/128737
\makeatletter
\patchcmd{\beamer@sectionintoc}{\vskip1.5em}{\vskip0.5em}{}{}
\makeatother

\begin{document}

%===============================================================%
\begin{frame}[plain,noframenumbering]
    \titlepage
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}{Outline of the talk}
    \tableofcontents[subsectionstyle=hide]
\end{frame}
%===============================================================%



%===============================================================%
\section{A short recap from last time}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}{By now, this is how your workflow looks like}
    \begin{center}
        \begin{tikzpicture}[node distance=3mm, bezier bounding box] % \usetikzlibrary{bbox}
            \coordinate (N0) at (0,0);
            \foreach \n/\c [count=\i from 0, count=\ip from 1] in {Work/PS, git status git diff/PP, git add/PB, git commit/PT}{
                \begin{scope}[scope on=<1->]
                    \node[space=\c, below = of N\i, xshift=25mm] (N\ip) {\n};
                    \ifnum\i>0%
                    \path[thick, to] (N\i.east) edge[out=0, in=90] (N\ip.north);
                    \fi
                \end{scope}
            }
            \path[visible on=<1->, thick, dotted, to] (N4.west) edge[out=180, in=180, looseness=1.6] (N2.west);
            \path[visible on=<1->, thick, to] (N4.south) edge[out=270, in=180, looseness=1.3] (N1.west);
        \end{tikzpicture}
    \end{center}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\newcommand{\GitCommand}[6][midway]{%
    \draw[#2] ($(N#3.south)!#5!(E#3)$) -- node[#1, fill=BGLIGHT, font=\ttfamily\scriptsize] {#6} ($(N#4.south)!#5!(E#4)$);
}
\begin{frame}{Our mental picture, so far}{On your local machine}
    \vspace{-0.1\textheight}
    \begin{center}
        \begin{tikzpicture}[node distance=25mm]
            \begin{scope}[scope on=<1->]
                \coordinate (N0) at (0,0);
                \foreach \n/\c [count=\i from 0, count=\ip from 1] in {Workspace/PS, Staging area/PP, Local repository/PB}{
                    \node[space=\c, right = of N\i] (N\ip) {\n};
                    \draw[very thin] (N\ip) -- coordinate[pos=1] (E\ip) ++(0,-5);
                }
            \end{scope}
            \begin{scope}[scope on=<1->]
                \node[text=PQ, font=\ttfamily\scriptsize] at ($(N1)!0.5!(N2)$) {git status};
                \node[text=PQ, font=\ttfamily\scriptsize] at ($(N3.north)+(0,0.3)$) {git log};
                \node[text=PQ, font=\ttfamily\scriptsize] at ($(N3.north)+(0,0.7)$) {git show};
                \GitCommand{fromto,PQ}{1}{2}{0.10}{git diff}
                \GitCommand{fromto,PQ}{2}{3}{0.25}{git diff --staged}
                \GitCommand{to}{1}{2}{0.65}{git add}
                \GitCommand{from}{1}{2}{0.80}{git restore --staged}
                \GitCommand{to}{2}{3}{0.95}{git commit}
                \path[to, PQ] ($($(N3.south)!0.45!(E3)$)!0.65!($(N2.south)!0.45!(E2)$)$) edge[out=180, in=0] ($(N2.south)!0.35!(E2)$);
                \GitCommand[pos=0.8]{fromto,PQ}{1}{3}{0.45}{git diff HEAD}
                \node[text=PT] at ($($(N1.south)!0.47!(E1)$)!0.8!($(N3.south)!0.51!(E3)$)$) {\Remark{only tracked files}};
            \end{scope}
        \end{tikzpicture}
        \par\medskip
        {\small Commands marked in \PQ{dark red} do not change anything in the repository!}
        \FrameRemark{Git introduced \texttt{git-restore} in v2.23 but this stayed buggy for a while. Use it from v2.27 on, otherwhise use \texttt{git-reset}.}
    \end{center}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\newsavebox{\lstclonebox}
\begin{frame}<1-3>[fragile,label=MentalPicture]
    \frametitle<1-3>{The complete correct abstract mental setup}
    \frametitle<4->{Cloning a remote repository}
    \begin{lrbox}{\lstclonebox}
        \begin{lstlisting}[style=MyBash]
            # Clone, i.e. download, a remote repository in present directory
            $ git clone |+<path-or-url-to-repository> [<optional-folder-name>]+|
        \end{lstlisting}
    \end{lrbox}
    \begin{tikzpicture}[node distance=5mm]
        \coordinate (N0) at (0,0);
        \foreach \n/\c [count=\i from 0, count=\ip from 1] in {Stashing area/PQ, Workspace/PS, Staging area/PP, Local repository/PB, Remote repository/PT}{
            \node[space=\c, right = of N\i] (N\ip) {\n};
            \draw[very thin] (N\ip) -- coordinate[pos=1] (E\ip) ++(0,-5);
        }
        \path coordinate (DNE) at ($(N4.north east)!0.5!(N5.north west)+(0,1)$)
              coordinate (DSE) at ($(DNE)-(0,7.1)$)
              coordinate (DNW) at ($(N1.north east)!0.5!(N2.north west)+(0,1)$)
              coordinate (DSW) at ($(DNW)-(0,7.1)$);
        \draw[thin, dashed] (DNE) -- (DSE);
        \draw ($(N1.north west)-(0.1,0)$) -- ++(0,0.2) -| ($(N4.north east)+(0.1,0)$);
        \node[font=\small, anchor=south, inner sep=0pt] at ($(N1.north)!0.5!(N4.north)+(0,0.4)$) {Local machine};
        \node[draw=red, very thick, rounded corners=1mm, fill=yellow, text width=0.9\textwidth, align=center, font=\bfseries\large, text=red, visible on=<3>]
            at ($(N3.south)!0.5!(E3)$) {It's all about having this picture clear in mind and understand how git commands affect it};
        \begin{onlyenv}<1>
            \fill[Gray, fill opacity=0.95] (DNW) rectangle ($(DSW)-(2.3,0)$) node[pos=0.5, rotate=90, text=BGLIGHT, font=\large\bfseries] {Next Z02 Git talk};
            \fill[Gray, fill opacity=0.95] (DNE) rectangle ($(DSE)+(2.3,0)$) node[pos=0.5, rotate=90, text=BGLIGHT, font=\large\bfseries] {Next Z02 Git talk};
        \end{onlyenv}
        \node[visible on=<1-3>] at ($(DSW)!0.5!(DSE)-(0,0.3)$) {\alt<1>{What we explored last time}{Today we'll complete the picture}};
        % Second slide
        \fill[Gray, fill opacity=0.98, visible on=<4>] ($(DNW)-(2.3,0)$) rectangle ($(DSE)-(0,0)$) node[pos=0.5, rotate=37, text=BGLIGHT, font=\large\bfseries] {Nothing existing before cloning the remote repository};
        \node[visible on=<5>] at ($(N3.south)!0.5!(E3)-(0.1,0)$) {\usebox{\lstclonebox}};
    \end{tikzpicture}
\end{frame}
%===============================================================%


%\begin{comment}
%===============================================================%
\section{Using branches}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}{A key feature of Git}
    \vspace{-5mm}
    \begin{overlayarea}{\textwidth}{0.7\textheight}
        \begin{itemize}
            \item Branches store \textbf{different versions of your project}
            \item Technically just pointers to a commit\\[2\itemsep]
                  \begin{onlyenv}<1>
                      \begin{tikzpicture}
                          \node (fig) {\includegraphics[width=0.88\textwidth]{Branches}};
                          \node[anchor=south west, font=\footnotesize] at ($(fig.south west)+(0,0.2)$)
                              {Picture taken from \URL*{https://www.atlassian.com/git/tutorials/using-branches}{Bitbucket branches tutorial}};
                      \end{tikzpicture}
                  \end{onlyenv}
            \item<2-> They enable parallel development
                  \begin{itemize}
                      \item Implement new features
                      \item Fix bugs
                      \item Try out something
                      \item {}[\ldots]
                  \end{itemize}
            \item<2-> The always existing \;\PB{\texttt{main}}\; branch:
                  \begin{itemize}
                      \item By default created at initialization
                      \item Development should be done on other branches
                      \item Till few years ago it was called \;\PB{\texttt{master}}
                  \end{itemize}
        \end{itemize}
    \end{overlayarea}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}[fragile]{Git branch}
    \begin{lstlisting}[style=MyBash]
        # List all existing local branches
        $ git branch
        * |-main-|
    \end{lstlisting}
    \begin{lstlisting}[style=MyBash]
        # Create a new branch
        $ git branch new-branch
        $ git branch
        * |-main-|
        |+  new-branch+|
    \end{lstlisting}
    \begin{lstlisting}[style=MyBash]
        # Delete a branch
        $ git branch -d new-branch
        |+Deleted branch new-branch (was a45b032).+|
        $ git branch
        * |-main-|
    \end{lstlisting}
    \begin{varblock}{alert}[\textwidth]{Git is safe}
        \small
        If a modifications would be lost, Git does not allow you to delete the branch using the \texttt{-d} option.
        Use the \texttt{-D} option instead.
    \end{varblock}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}[fragile]{Git switch}
    \vspace{-8mm}
    \begin{overlayarea}{\textwidth}{0.8\textheight}
        \begin{varblock}{}[0.7\textwidth]{}
            \PB{This will in general change your workspace!}
        \end{varblock}
        \begin{lstlisting}[style=MyBash]
            # Switching to another branch
            $ git branch
            * |-main-|
            |+  new-branch+|
            $ git switch new-branch
            |+Switched to branch 'new-branch'+|
            $ git branch
            |+  main+|
            * |-new-branch-|
        \end{lstlisting}
        \begin{varblock}{alert}[\textwidth]{Git is safe}<only@1>
            \small
            You may switch branches with uncommitted changes in the work-tree if and only if said switching does not require clobbering those changes.
        \end{varblock}
        \begin{onlyenv}<2>
            \begin{lstlisting}[style=MyBash]
                # Creating and switching to a new branch at once
                $ git switch -c another-branch
                |+Switched to a new branch 'another-branch'+|
                $ git branch
                * |-another-branch-|
                |+  main+|
            \end{lstlisting}
        \end{onlyenv}
    \end{overlayarea}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}{Merging branches}
    \setlength{\leftmargini}{0.6cm}
    \begin{itemize}
        \item To merge means to unify the snapshots of two different branches
        \item This is automatically done by Git in a clever way
        \item When Git does not know how to merge the content of some file, it will create a conflict
        \item If conflicts occur, the merge will not automatically finish
        \item A merge can be aborted
        \item To fix conflicts, open and manually adjust files where Git failed
    \end{itemize}
    \medskip
    \begin{varblock}{alert}[0.65\textwidth]{}
        \alert{Git is safe, conflicts are not a bad thing!}
    \end{varblock}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}{Different types of merge}
    \hspace*{-3mm}
    \begin{tikzpicture}[node distance=4mm]
        \node (3W1) {\includegraphics[width=0.42\textwidth]{Merge-3way_before}};
        \node[below = 1mm of 3W1.south west, anchor=north west] (3W2) {\includegraphics[width=0.52\textwidth]{Merge-3way_then}};
        \node[left  = of 3W1] (FF1) {\includegraphics[width=0.38\textwidth]{Merge-FF_before}};
        \node[left  = of 3W2] (FF2) {\includegraphics[width=0.38\textwidth]{Merge-FF_then}};
        \begin{scope}[every node/.style={font=\small}]
            \node[left = 2mm of FF1] (BL) {\rotatebox{90}{Before}};
            \node[left = 2mm of FF2] (AL) {\rotatebox{90}{After}};
            \node[above = 34mm of 3W2] (3WL) {Three-way merge};
            \node at (3WL -| FF1) (FFL) {Fast-forward merge};
        \end{scope}
        \draw ({$(FF1.east)!0.5!(3W1.west)$} |- FFL.north) -- ({$(FF1.east)!0.5!(3W1.west)$} |- 3W2.south);
        \draw ({$(FF1.south)!0.5!(FF2.north)$} -| AL.west) -- ({$(FF1.south)!0.5!(FF2.north)$} -| 3W2.east);
    \end{tikzpicture}
    \FrameRemark{Pictures taken from \URL*{https://www.atlassian.com/git/tutorials/using-branches/git-merge}{Bitbucket git-merge tutorial}.}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}[fragile]{Git merge: How does it work?}
    \vspace{-3mm}
    \setlength{\leftmargini}{5mm}
    \begin{enumerate}
        \item If possible, Git performs a fast-forward merge
        \item Otherwise a three-way merge is done and a new commit created
    \end{enumerate}
    \begin{varblock}{}[0.75\textwidth]{Be sure to be on the correct branch!}
        \begin{lstlisting}[style=MyBash, xrightmargin=11mm, xleftmargin=11mm, aboveskip=2mm]
            |+   +|git merge |+<source-branch>+|
        \end{lstlisting}
        It incorporates changes from the specified\\ branch into the present branch!
    \end{varblock}
    \vspace{3mm}
    \begin{lstlisting}[style=MyBash]
        # It is possible to force a three-way merge:
        $ git merge --no-ff |+<source-branch>+|
    \end{lstlisting}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}[fragile]{Merge conflicts: Fixing procedure}
    \begin{lstlisting}[style=MyBash, xleftmargin=-1mm, xrightmargin=-1mm]
        # A general example
        $ git merge <branch_name>
        |+Auto-merging <file>
        CONFLICT (content): Merge conflict in <file>
        Automatic merge failed; fix conflicts and then commit the result.+|
    \end{lstlisting}
    \vspace{3mm}
    \begin{enumerate}
        \small
        \item Run \,\texttt{git status}\, to see \alert{unmerged paths}
        \item Find problematic hunks in files that contain conflicts\\
              \then Look for delimiters in the files:
              {~\footnotesize\texttt{<<<<<<<},\; \texttt{=======},\; \texttt{>>>>>>>}}
        \item Remove delimiters and adjust content
        \item Check the project works (e.g. compile, run tests)
        \item \texttt{git add}\, the files with fixed conflicts
        \item Commit added files\\
              \then Git propose you an auto-generated commit message
    \end{enumerate}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\AlertFrame{Live example!}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}[plain]{}
    \centering
    \vfill
    \animategraphics[loop,autoplay,width=0.8\paperwidth]{20}{../Figures/Wow/Wow-}{0}{100}
    \vfill
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
%===============================================================%
%\end{comment}

%===============================================================%
\section{Working with remote repositories}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\againframe<4->{MentalPicture}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}[fragile]{Cloning a remote repository}
    \begin{lstlisting}[style=MyBash, xleftmargin=-1mm, xrightmargin=-1mm]
        # Clone the repository of this course
        $ ls
        $ git clone git@github.com:AxelKrypton/Git-crash-course.git
        |+Cloning into 'Git-crash-course'...
        remote: Enumerating objects: 82, done.
        remote: Counting objects: 100% (66/66), done.
        remote: Compressing objects: 100% (47/47), done.
        remote: Total 82 (delta 26), reused 52 (delta 18), pack-reused 16
        Receiving objects: 100% (82/82), 4.47 MiB | 4.49 MiB/s, done.
        Resolving deltas: 100% (29/29), done.+|
        $ ls
        @|\ttc{Blue}{Git-crash-course}|@
    \end{lstlisting}
    \begin{varblock}{}[0.75\textwidth]{}
        The local repository is aware of the remote one!
    \end{varblock}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}[fragile]{Git remote}
    \vspace{-3mm}
    \begin{varblock}{}[0.6\textwidth]{}
        In the local repository, the remote one is (by default) referred as \textbf{origin}
    \end{varblock}
    \begin{lstlisting}[style=MyBash, xleftmargin=-1mm, xrightmargin=-1mm]
        # Check out the remote information
        $ cd Git-crash-course
        $ git remote
        origin
        $ git remote -v
        |+origin    git@github.com:AxelKrypton/Git-crash-course.git (fetch)
        origin    git@github.com:AxelKrypton/Git-crash-course.git (push)+|
        $ git remote rename origin GitHub
        $ git remote
        |+GitHub+|
        # A repository can have multiple remote locations
        $ git remote add MyServer <url-to-new-remote>
        $ git remote
        |+GitHub
        MyServer+|
    \end{lstlisting}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}[fragile]{First interactions with the remote repository}
    \begin{lstlisting}[style=MyBash]
        $ git branch -r
        @|\ttc{red!92!black}{~~origin/HEAD}|@ -> origin/main
        @|\ttc{red!92!black}{~~origin/main}|@
        @|\ttc{red!92!black}{~~origin/experiment}|@
        $ git branch -a
        * |-main-|
        @|\ttc{red!92!black}{~~remotes/origin/HEAD}|@ -> origin/main
        @|\ttc{red!92!black}{~~remotes/origin/main}|@
        @|\ttc{red!92!black}{~~remotes/origin/experiment}|@
    \end{lstlisting}
    \begin{lstlisting}[style=MyBash]
        # Switch to a new branch that mirrors the state of a remote one
        $ git switch experiment
        |+Branch 'experiment' set up to track remote branch 'experiment' from 'origin'.
        Switched to a new branch 'experiment'+|
        $ git branch -vv
        * |-experiment-|    a1d62e63 [@|\ttc{Blue}{origin/experiment}|@] last-commit-message
        |+  main+|         a1d62e63 [@|\ttc{Blue}{origin/main}|@] last-commit-message
    \end{lstlisting}
    \medskip
    \centerline{We'll come back to the idea of tracking in a moment!}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}[fragile]{Fetching and pulling}
    \vspace{-3mm}
    \begin{overlayarea}{\textwidth}{0.7\textheight}
        \begin{varblock}{}[\textwidth]{}
            When collaborating in a project, the remote repository will in general change because of other people's work
        \end{varblock}
        \vspace{3mm}
        \begin{onlyenv}<1>
            \begin{lstlisting}[style=MyBash]
                $ git fetch <remote-name>
            \end{lstlisting}
            \begin{itemize}
                \item Information about the remote repository (e.g.\ branches) can be updated by fetching from a remote
                \item \alert{Fetching does not change the local workspace!}
            \end{itemize}
        \end{onlyenv}
        \begin{onlyenv}<2>
            \begin{lstlisting}[style=MyBash]
                $ git pull <remote-name> <remote-branch-name>
            \end{lstlisting}
            \begin{itemize}
                \item Pulling instead is updating both the information about the remote repository and the local workspace
                \item \alert{Git pull is actual a shortcut to do a fetch followed by a merge with a remote branch}
            \end{itemize}
        \end{onlyenv}
    \end{overlayarea}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}[fragile]{Fetching and pulling: Examples}
    \begin{onlyenv}<1>
        \begin{lstlisting}[style=MyBash]
            # If there is only one remote, you can omit it
            $ git fetch origin
            |+a1e8fb5..45e66a4 main -> origin/main
            a1e8fb5..9e8ab1c develop -> origin/develop
            * [new branch] some-feature -> origin/some-feature+|
            # To remove locally references to remote deleted branches:
            $ git fetch --prune
            |+From github.com:AxelKrypton/Git-crash-course
            - [deleted]           (none)     -> origin/experiment+|
        \end{lstlisting}
        \begin{lstlisting}[style=MyBash]
            # Be sure to be on the correct branch before pulling
            $ git branch
            * |-main-|
            $ git pull origin main
            |+From github.com:AxelKrypton/Git-crash-course
            * branch            main       -> FETCH_HEAD
            Already up to date.+|
        \end{lstlisting}
    \end{onlyenv}
    \begin{onlyenv}<2>
        \begin{varblock}{}[\textwidth]{}
            If you created commits on the present branch, pulling it from remote will perform a merge and, if this is not a fast-forward merge, the editor to make a commit with an auto-generated message will be displayed to you. \alert{Conflicts might occur as well.}
        \end{varblock}
        \begin{lstlisting}[style=MyBash]
            $ git log --oneline
            |+a45b032 (HEAD -> main) Some work done locally on main
            6e5ea4b (origin/main, origin/HEAD) Last commit pulled
            236d4af Previous history+|
            # If I now pull and some new commit exists after 6e5ea4b
            #  => a 3-way merge occurs and the editor will open
            $ git pull origin master
            |+[...]+|
        \end{lstlisting}
    \end{onlyenv}
    \FrameRemark{These 3-way merge commits because of pulling operations are not ideal and next time we'll learn how to avoid them.}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}[fragile]{Pushing your own work}
    \vspace{-3mm}
    \begin{itemize}
        \item To push means to make the changes done in the local repository available in the remote one, i.e. to update a remote branch with a local one
        \item Only changes that are committed are pushed
        \item If the remote and the local history diverge (i.e. you forgot to pull before committing), the push operation will be rejected
    \end{itemize}
    \begin{varblock}{alert}[\textwidth]{}
        \alert{Push before saying to your collaborators you did some changes!}
    \end{varblock}
    \begin{lstlisting}[style=MyBash]
        $ git push origin main
        |+[...]+|
        # To delete remote branches 'git push' is also used:
        $ git push <remote-name> --delete <branch_name>
    \end{lstlisting}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}{How does this fit into our mental picture?}
    \vspace{-0.1\textheight}
    \begin{center}
        \begin{tikzpicture}[node distance=5mm]
            \begin{scope}[scope on=<1->]
                \foreach \n/\c [count=\i from 0, count=\ip from 1] in {Stashing area/PQ, Workspace/PS, Staging area/PP, Local repository/PB, Remote repository/PT}{
                    \node[space=\c, right = of N\i] (N\ip) {\n};
                    \draw[very thin] (N\ip) -- coordinate[pos=1] (E\ip) ++(0,-5);
                }
                \path coordinate (DNE) at ($(N4.north east)!0.5!(N5.north west)+(0,1)$)
                      coordinate (DSE) at ($(DNE)-(0,7.1)$)
                      coordinate (DNW) at ($(N1.north east)!0.5!(N2.north west)+(0,1)$)
                      coordinate (DSW) at ($(DNW)-(0,7.1)$);
                %\draw[thin, dashed] (DNE) -- (DSE);
                \draw ($(N1.north west)-(0.1,0)$) -- ++(0,0.2) -| ($(N4.north east)+(0.1,0)$);
                \node[font=\small, anchor=south, inner sep=0pt] at ($(N1.north)!0.5!(N4.north)+(0,0.4)$) {Local machine};
            \end{scope}
            \begin{scope}[scope on=<2->]
                \node[text=PQ, font=\ttfamily\scriptsize] at ($(N5.north)+(0,0.3)$) {git remote};
                \GitCommand{from}{4}{5}{0.20}{git fetch}
                \GitCommand{from}{2}{4}{0.40}{git merge origin/[...]}
                \GitCommand{from}{2}{5}{0.60}{git pull <remote> <branch>}
                \GitCommand{to}{4}{5}{0.80}{git push}
            \end{scope}
        \end{tikzpicture}
        \par\medskip
        \uncover<2>{\small \alert{Keep in mind that it is very tough (if not impossible) to undo these commands.}}
    \end{center}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}[fragile]{Few words about tracking branches}
    \vspace{-8mm}
    \begin{overlayarea}{\textwidth}{0.85\textheight}
        \begin{varblock}{alert}[\textwidth]{A convenient feature}
            It is possible to make a default association between a local and a remote branch which is used for pull and push operations!
        \end{varblock}
        \begin{onlyenv}<1>
            \begin{lstlisting}[style=MyBash, xrightmargin=-1mm, xleftmargin=-1mm]
                $ git branch -a -vv
                |+  exp1              6e5ea4b Commit msg
                  exp2              6e5ea4b Commit msg+|
                * |-main-|              6e5ea4b [@|\ttc{Blue}{origin/main}|@] Commit msg
                |+  +|@|\ttc{red!92!black}{remotes/origin/HEAD}|@ -> origin/main
                |+  +|@|\ttc{red!92!black}{remotes/origin/main}|@ 6e5ea4b Commit msg
                |+  +|@|\ttc{red!92!black}{remotes/origin/exp1}|@ 6e5ea4b Commit msg
            \end{lstlisting}
            \begin{lstlisting}[style=MyBash, xrightmargin=-1mm, xleftmargin=-1mm]
                # First possibility (when remote branch already exists)
                $ git switch exp1
                |+Switched to branch 'exp1'+|
                $ git branch --set-upstream-to=origin/exp1
                |+Branch 'exp1' set up to track remote branch 'exp1' from 'origin'.+|
            \end{lstlisting}
        \end{onlyenv}
        \begin{overlayarea}{\textwidth}{0.35\textheight}
            \vspace{-2mm}
            \begin{onlyenv}<2>
                \begin{lstlisting}[style=MyBash, xrightmargin=-1mm, xleftmargin=-1mm]
                    # Second possibility (even without remote branch, yet)
                    $ git switch exp2
                    |+Switched to branch 'exp2'+|
                    $ git push -u origin exp2
                    |+[...]
                    To github.com:AxelKrypton/Git-crash-course.git
                    * [new branch]      exp2 -> exp2
                    Branch 'exp2' set up to track remote branch 'exp2' from 'origin'.+|
                \end{lstlisting}
            \end{onlyenv}
            \begin{onlyenv}<3>
                \begin{varblock}{}[\textwidth]{Between tracking branches}
                    \PB{It is then possible to simply use \textbf{\PP{git pull}} and \textbf{\PP{git push}} commands!}
                \end{varblock}
            \end{onlyenv}
        \end{overlayarea}
        \begin{onlyenv}<2->
            \vspace{-5pt}
            \begin{lstlisting}[style=MyBash, xrightmargin=-1mm, xleftmargin=-1mm]
                # Check branch tracking associations
                $ git branch -vv
                  exp1              6e5ea4b [@|\ttc{Blue}{origin/exp1}|@] Commit msg
                * |-exp2-|              6e5ea4b [@|\ttc{Blue}{origin/exp2}|@] Commit msg
                  main              6e5ea4b [@|\ttc{Blue}{origin/main}|@] Commit msg
            \end{lstlisting}
        \end{onlyenv}
    \end{overlayarea}
\end{frame}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%

%git clone
%git fetch
%git pull
%git push
%===============================================================%


%===============================================================%
\section{A bare repository}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
%===============================================================%


%===============================================================%
\section{The stashing area}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
%===============================================================%


%===============================================================%
\section{The remaining git commands}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
%mv                Move or rename a file, a directory, or a symlink
%restore           Restore working tree files
%rm                Remove files from the working tree and from the index
%sparse-checkout   Initialize and modify the sparse-checkout
%
%bisect            Use binary search to find the commit that introduced a bug
%grep              Print lines matching a pattern
%
%rebase            Reapply commits on top of another base tip
%reset             Reset current HEAD to the specified state
%tag               Create, list, delete or verify a tag object signed with GPG
%===============================================================%



%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
\begin{frame}{That's \textbf{NOT} all folks}
    \vspace{0.02\textheight}
    \begin{enumerate}[<+->]
        \item Start using Git.
              \alert{\textbf{Now.}}
              Not tomorrow or next week, today!\\
              $\to\;$ Repeat what done on these slides
        \item Was anything unclear?
              Do you get stuck at some point?\\
              $\to\;$ Drop me \PP{\href{mailto:sciarra@itp.uni-frankfurt.de}{{\small\faEnvelope}\;an email}}
        \item Git is much more than this!\\
              $\to\;$ Come to next Z02 talk: \alert{\guillemotleft Let's git \textbf{together}\tikzmark{tg}\guillemotright}
    \end{enumerate}
    \begin{tikzpicture}[remember picture, overlay, scope on=<.->]
        \node[anchor=west, space=PT, text width=18mm] (content) at ($(tg)+(0.5,-0.8)$) {
            git clone\\
            git branch\\
            git switch\\
            git checkout\\
            git merge\\
            git pull\\
            git push
        };
        \path[to, shorter={0mm}{1mm}] ($(tg)-(0.6,0.25)$) edge[out=270, in=180] (content.west);
    \end{tikzpicture}
    \par\vspace{0.02\textheight}
    \begin{uncoverenv}<+->
        \begin{tikzpicture}[remember picture, overlay]
            \node[anchor=north east, cloud, aspect=3, cloud puffs=15, draw=PB, fill=PP!20, text=PB]
                at ($(current page.north east)+(-14mm,-6mm)$) {Thank you!};
        \end{tikzpicture}
        \begin{minipage}{0.8\textwidth}
            \begin{center}
                \large\bfseries\PQ{Believe me, it's worth it!}
            \end{center}
        \end{minipage}
    \end{uncoverenv}
\end{frame}
%===============================================================%

\end{document}
